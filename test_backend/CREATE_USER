#!/bin/bash
# create-user.sh
# Script to create users in the workshop API

# Configuration
# Local URL of the API
#API_URL="http://localhost:8000"

# Remote URL of the API for the workshop
API_URL="http://pers-grhino001.sjcvirt.rti.com:8000"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to exit safely
safe_exit() {
    local exit_code=$1
    
    if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
        return $exit_code
    else
        exit $exit_code
    fi
}

# Help function
show_help() {
    echo -e "${BLUE}üìù Script to create users${NC}"
    echo ""
    echo "Usage:"
    echo "  $0 <name> <email> <role>"
    echo ""
    echo "Parameters:"
    echo "  name   - Full name of the user"
    echo "  email  - User's email (must be unique)"
    echo "  role   - User's role (Developer, Designer, Manager, etc.)"
    echo ""
    echo "Examples:"
    echo "  $0 \"John Doe\" \"john@example.com\" \"Developer\""
    echo "  $0 \"Jane Smith\" \"jane@example.com\" \"Designer\""
    echo "  $0 \"Bob Johnson\" \"bob@example.com\" \"Manager\""
    echo ""
    echo "Interactive mode (no parameters):"
    echo "  $0"
    echo ""
}

# Check if help was requested
if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    show_help
    safe_exit 0
fi

# ============================================
# MODE 1: Parameters provided
# ============================================
if [ $# -eq 3 ]; then
    NAME="$1"
    EMAIL="$2"
    ROLE="$3"

# ============================================
# MODE 2: Interactive mode
# ============================================
elif [ $# -eq 0 ]; then
    echo -e "${BLUE}üìù Create new user (interactive mode)${NC}"
    echo ""
    
    # Ask for name
    read -p "Full name: " NAME
    if [ -z "$NAME" ]; then
        echo -e "${RED}‚ùå Name cannot be empty${NC}"
        safe_exit 1
    fi
    
    # Ask for email
    read -p "Email: " EMAIL
    if [ -z "$EMAIL" ]; then
        echo -e "${RED}‚ùå Email cannot be empty${NC}"
        safe_exit 1
    fi
    
    # Basic email validation
    if [[ ! "$EMAIL" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
        echo -e "${RED}‚ùå Invalid email: ${EMAIL}${NC}"
        safe_exit 1
    fi
    
    # Ask for role
    echo ""
    echo "Suggested roles:"
    echo "  1) Developer"
    echo "  2) Designer"
    echo "  3) Manager"
    echo "  4) QA Tester"
    echo "  5) Product Owner"
    echo "  6) Other (custom)"
    echo ""
    read -p "Select a role (1-6) or type a custom one: " ROLE_CHOICE
    
    case $ROLE_CHOICE in
        1) ROLE="Developer" ;;
        2) ROLE="Designer" ;;
        3) ROLE="Manager" ;;
        4) ROLE="QA Tester" ;;
        5) ROLE="Product Owner" ;;
        6)
            read -p "Custom role: " ROLE
            if [ -z "$ROLE" ]; then
                echo -e "${RED}‚ùå Role cannot be empty${NC}"
                safe_exit 1
            fi
            ;;
        *)
            # If they type the role directly
            ROLE="$ROLE_CHOICE"
            ;;
    esac

# ============================================
# MODE 3: Incorrect number of parameters
# ============================================
else
    echo -e "${RED}‚ùå Incorrect number of parameters${NC}"
    echo ""
    show_help
    safe_exit 1
fi

# ============================================
# Final validations
# ============================================

# Validate that no field is empty
if [ -z "$NAME" ] || [ -z "$EMAIL" ] || [ -z "$ROLE" ]; then
    echo -e "${RED}‚ùå All fields are required${NC}"
    safe_exit 1
fi

# ============================================
# Create user
# ============================================

echo ""
echo -e "${YELLOW}üì§ Creating user...${NC}"
echo "  Name:  $NAME"
echo "  Email: $EMAIL"
echo "  Role:  $ROLE"
echo ""

# Build JSON
JSON_PAYLOAD=$(cat <<EOF
{
  "name": "$NAME",
  "email": "$EMAIL",
  "role": "$ROLE"
}
EOF
)

# Make request
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST ${API_URL}/users \
  -H "Content-Type: application/json" \
  -d "$JSON_PAYLOAD")

# Separate body and status code
HTTP_BODY=$(echo "$RESPONSE" | head -n -1)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

# ============================================
# Process response
# ============================================

if [ "$HTTP_CODE" -eq 201 ]; then
    echo -e "${GREEN}‚úÖ User created successfully${NC}"
    echo ""
    
    if command -v jq &> /dev/null; then
        echo "User details:"
        echo "$HTTP_BODY" | jq .
    else
        echo "Response:"
        echo "$HTTP_BODY"
    fi
    
    safe_exit 0
    
elif [ "$HTTP_CODE" -eq 400 ]; then
    echo -e "${RED}‚ùå Error: Email already exists or invalid data${NC}"
    echo ""
    
    if command -v jq &> /dev/null; then
        ERROR_MSG=$(echo "$HTTP_BODY" | jq -r '.detail // "Unknown error"')
        echo "Detail: $ERROR_MSG"
    else
        echo "$HTTP_BODY"
    fi
    
    safe_exit 1
    
else
    echo -e "${RED}‚ùå Error creating user (HTTP $HTTP_CODE)${NC}"
    echo ""
    echo "Is the server running at ${API_URL}?"
    echo ""
    
    if [ -n "$HTTP_BODY" ]; then
        echo "Server response:"
        echo "$HTTP_BODY"
    fi
    
    safe_exit 1
fi